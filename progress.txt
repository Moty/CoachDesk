# Ralph Progress Log
Started: Thu Jan 22 23:47:56 PST 2026
---
## 2026-01-24T02:35:00Z - US-001
- Implemented DEFAULT_ORGANIZATION_ID env config for user registration
- Added validation to env.config.ts requiring DEFAULT_ORGANIZATION_ID
- Updated .env.example and .env with new config field
- Fixed pre-existing typecheck error in rateLimiter.middleware.ts (ipKeyGenerator expects IP string, not Request object)
- Files changed:
  - src/shared/config/env.config.ts
  - .env.example
  - .env
  - src/shared/middleware/rateLimiter.middleware.ts
- **Learnings for future iterations:**
  - [PATTERN]: Config validation is centralized in src/shared/config/env.config.ts
  - [GOTCHA]: express-rate-limit ipKeyGenerator expects req.ip string, not the Request object
  - [INTEGRATION]: Registration will use config.defaultOrganizationId for new user assignment
---
## 2026-01-24T04:45:00Z - US-002
- Implemented POST /api/v1/auth/register endpoint for self-service user registration
- Created auth.controller.ts with register function accepting email, password, displayName
- Creates Firebase Auth user with password and sets custom claims (role: customer, organizationId)
- Creates Firestore users document with complete user profile
- Returns sanitized user payload (excludes password)
- Files changed:
  - src/api/controllers/auth.controller.ts (new)
  - src/api/routes/auth.routes.ts (new)
  - src/index.ts (added auth routes)
  - tests/api/controllers/auth.controller.test.ts (new)
- **Learnings for future iterations:**
  - [PATTERN]: Auth endpoints go in /api/v1/auth namespace
  - [PATTERN]: Self-registration always uses default customer role from UserRole.CUSTOMER
  - [PATTERN]: All auth controller methods follow same validation pattern: email, password, displayName
  - [INTEGRATION]: Registration uses config.defaultOrganizationId from env.config.ts
  - [GOTCHA]: Firebase Admin createUser accepts password directly, no need to hash
---
## 2026-01-24T04:46:00Z - US-003
- Implemented React + TypeScript frontend with registration UI flow
- Created Vite-based React application in web/ directory
- Added /register route with email, displayName, and password fields
- Client-side validation for required fields and password length >= 8
- Calls POST /api/v1/auth/register and displays API errors in UI
- On success, signs in user with Firebase Auth and redirects to /
- Files changed:
  - web/package.json (new)
  - web/vite.config.ts (new)
  - web/tsconfig.json (new)
  - web/src/main.tsx (new)
  - web/src/App.tsx (new)
  - web/src/firebase.ts (new)
  - web/src/contexts/AuthContext.tsx (new)
  - web/src/pages/Register.tsx (new)
  - web/src/pages/Login.tsx (new)
  - web/src/pages/Home.tsx (new)
  - web/src/vite-env.d.ts (new)
- **Learnings for future iterations:**
  - [PATTERN]: Frontend uses React Router for routing with /login, /register, / paths
  - [PATTERN]: AuthContext provides user authentication state across the app
  - [PATTERN]: All API calls use VITE_API_BASE_URL from .env
  - [INTEGRATION]: Firebase Auth client SDK handles authentication tokens
  - [GOTCHA]: Must define ImportMetaEnv in vite-env.d.ts for Vite env variables
---
## 2026-01-24T04:47:00Z - US-004
- Created idempotent seed script for initial admin user
- Script creates Firebase Auth user moty.moshin@gmail.com with password 12345678
- Sets custom claims: role=admin, organizationId=DEFAULT_ORGANIZATION_ID
- Creates Firestore users document if missing
- Safe to re-run without creating duplicates
- Files changed:
  - scripts/seed-admin.ts (new)
  - package.json (added seed:admin script)
- **Learnings for future iterations:**
  - [PATTERN]: Seed scripts use tsx to run TypeScript directly
  - [PATTERN]: Check for existing user with getUserByEmail before creating
  - [GOTCHA]: Must handle auth/user-not-found error code when checking existence
  - [INTEGRATION]: Seed script connects to Firestore using FirestoreAdapter
---
## 2026-01-24T04:57:00Z - US-005
- Implemented typed API client with error handling
- Created web/src/lib/api.ts with full CRUD methods (GET, POST, PATCH, DELETE)
- API client attaches Authorization Bearer token from Firebase Auth
- Handles backend error format { code, message, details } with user-friendly messages
- Supports pagination and filtering via query params
- Supports file upload with multipart/form-data and field name 'file'
- Files changed:
  - web/src/lib/api.ts (new)
  - web/src/lib/__tests__/api.test.ts (new)
  - web/vite.config.ts (added vitest test config)
  - web/package.json (added test scripts)
  - web/package-lock.json (added vitest dependencies)
- **Learnings for future iterations:**
  - [PATTERN]: API client exports `api` object with get/post/patch/delete/uploadFile methods
  - [PATTERN]: User-friendly error messages mapped from backend error codes in getUserFriendlyMessage()
  - [PATTERN]: Authorization token automatically fetched from Firebase Auth currentUser
  - [INTEGRATION]: API client uses VITE_API_BASE_URL from environment config
  - [GOTCHA]: Vitest mocks require async beforeEach to properly reset auth.currentUser
---
## 2026-01-24T05:00:00Z - US-006
- Implemented role-based routing and access denied state
- Created UserRole enum and User type in web/src/types/user.ts
- Updated AuthContext to fetch current user via GET /api/v1/users/me on app load
- AuthContext now stores both Firebase user and application user with role
- Created RoleRoute component for gating routes by role
- Created AccessDenied page displayed when user lacks permission
- Updated App.tsx to include /access-denied route
- Updated Home page to display user role for verification
- Files changed:
  - web/src/types/user.ts (new)
  - web/src/contexts/AuthContext.tsx
  - web/src/components/RoleRoute.tsx (new)
  - web/src/pages/AccessDenied.tsx (new)
  - web/src/pages/Home.tsx
  - web/src/App.tsx
- **Learnings for future iterations:**
  - [PATTERN]: User types should match backend domain models (UserRole enum matches src/domain/models/User.ts)
  - [PATTERN]: AuthContext fetches user data after Firebase authentication to get role and organization
  - [PATTERN]: RoleRoute component can be used to protect routes: <RoleRoute allowedRoles={[UserRole.ADMIN]}>
  - [INTEGRATION]: GET /api/v1/users/me endpoint returns full user profile including role
  - [GOTCHA]: Firebase User from auth lib doesn't include custom claims, must fetch from backend
---
## 2026-01-24T05:01:00Z - US-007
- Implemented Tickets list page with pagination
- Created ticket types (TicketStatus, TicketPriority, Ticket, TicketsResponse) in web/src/types/ticket.ts
- Created Tickets page component that calls GET /api/v1/tickets with pagination
- Renders ticket rows with subject, status, priority, requester, and updatedAt
- Shows empty-state message when no tickets found
- Added pagination controls with Previous/Next buttons
- Updated Home page to include "View Tickets" button for navigation
- Updated App.tsx to add /tickets route
- Files changed:
  - web/src/types/ticket.ts (new)
  - web/src/pages/Tickets.tsx (new)
  - web/src/App.tsx
  - web/src/pages/Home.tsx
- **Learnings for future iterations:**
  - [PATTERN]: Ticket types match backend domain models from src/domain/models/Ticket.ts
  - [PATTERN]: List pages follow pattern: loading state, error state, empty state, data table
  - [PATTERN]: Backend ticket API supports pagination via page/limit query params
  - [INTEGRATION]: GET /api/v1/tickets returns { tickets, total, page, limit } response
  - [GOTCHA]: Date strings from API need conversion using new Date() for formatting
---
## 2026-01-24T05:04:00Z - US-008
- Implemented ticket list filters and sorting UI
- Added filters for status (dropdown), priority (dropdown), assignee (text input), and tags (comma-separated text input)
- Added sorting controls for createdAt, updatedAt, and priority with asc/desc order
- Filters and sorting update API query params dynamically
- Added reset filters button to clear all filters and sorting
- All filters trigger page reset to 1 and reload tickets with updated params
- Files changed:
  - web/src/pages/Tickets.tsx
- **Learnings for future iterations:**
  - [PATTERN]: Backend listTickets endpoint supports status, priority, assigneeId, tags filters and sortBy/order params
  - [PATTERN]: Status and priority filters use enum dropdown for valid values
  - [PATTERN]: Tags filter accepts comma-separated values matching backend array-contains-any logic
  - [INTEGRATION]: All filter changes reset page to 1 to avoid empty result pages
  - [GOTCHA]: Must import TicketStatus and TicketPriority enums to use in select options
---
## 2026-01-24T05:18:00Z - US-009
- Implemented Ticket Detail page that loads GET /api/v1/tickets/:id
- Displays ticket metadata: status, priority, assignee, requester, tags, created/updated dates
- Shows SLA timers section with first response and resolution due/completed times
- Displays SLA breach status with red styling when breached
- Shows not-found state when ticket doesn't exist or user lacks permission
- Made ticket rows in Tickets.tsx clickable to navigate to detail page
- Added /tickets/:id route to App.tsx
- Files changed:
  - web/src/pages/TicketDetail.tsx (new)
  - web/src/App.tsx
  - web/src/pages/Tickets.tsx
- **Learnings for future iterations:**
  - [PATTERN]: Detail pages follow pattern: loading, not-found, error, and data display states
  - [PATTERN]: Use useParams hook from react-router-dom to get route params like :id
  - [PATTERN]: Navigate function from react-router-dom enables programmatic navigation
  - [PATTERN]: SLA timers should show breach status visually with red background/border
  - [INTEGRATION]: Ticket detail page displays all SLATimer fields from backend model
  - [GOTCHA]: Must handle undefined dates in SLA timers with fallback to 'N/A'
---
## 2026-01-24T05:21:00Z - US-010
- Implemented Ticket comments timeline that loads comments via GET /api/v1/tickets/:id/comments
- Created Comment and CommentsResponse types in web/src/types/comment.ts
- Updated TicketDetail page to load and display comments with pagination
- Comments timeline shows author, timestamp, and visibility label (Public/Internal)
- Internal comments are hidden from customers (filtered client-side)
- Public comments have blue background, internal comments have yellow background
- Added pagination controls for navigating through comments
- Files changed:
  - web/src/types/comment.ts (new)
  - web/src/pages/TicketDetail.tsx
- **Learnings for future iterations:**
  - [PATTERN]: Comments endpoint follows same pagination pattern as tickets (page/limit params)
  - [PATTERN]: Internal comments filtered client-side for customers using user.role check
  - [PATTERN]: Visual distinction between public (blue) and internal (yellow) comments
  - [INTEGRATION]: Comment type matches backend Comment model from src/domain/models/Comment.ts
  - [GOTCHA]: Must check user?.role against UserRole.CUSTOMER to filter internal comments
---
## 2026-01-24T05:21:30Z - US-011
- Implemented comment composer with form submission to POST /api/v1/tickets/:id/comments
- Added textarea for comment body and submit button
- Agents/admins can choose public vs internal visibility via checkbox
- Customers always post public comments (checkbox hidden for them)
- New comments appended to timeline without full page refresh
- Form clears and resets after successful submission
- Shows error message if submission fails
- Files changed:
  - web/src/pages/TicketDetail.tsx
- **Learnings for future iterations:**
  - [PATTERN]: Comment composer uses controlled form state with commentBody and isPublic
  - [PATTERN]: Customers forced to post public comments regardless of checkbox
  - [PATTERN]: New comments appended to state array to avoid full page reload
  - [INTEGRATION]: POST /api/v1/tickets/:id/comments accepts { body, isPublic } payload
  - [GOTCHA]: Must check user.role === UserRole.CUSTOMER to hide internal toggle
---
## 2026-01-24T05:24:00Z - US-012
- Implemented Create Ticket page with form posting to POST /api/v1/tickets
- Created CreateTicket.tsx with subject (1-255 chars) and description (1+ chars) validation
- Supports priority dropdown (Low/Medium/High/Urgent) and tags input (comma-separated)
- Navigates to new ticket detail page (/tickets/:id) on success
- Added "Create Ticket" button to Home page and Tickets list page
- Added /tickets/new route to App.tsx (placed before /tickets/:id to avoid route conflict)
- Files changed:
  - web/src/pages/CreateTicket.tsx (new)
  - web/src/App.tsx
  - web/src/pages/Home.tsx
  - web/src/pages/Tickets.tsx
- **Learnings for future iterations:**
  - [PATTERN]: Form pages follow pattern: controlled state, client-side validation, API call, navigation on success
  - [PATTERN]: Create forms validate required fields before submission (subject 1-255 chars, description 1+ chars)
  - [PATTERN]: POST /api/v1/tickets returns { id } which is used to navigate to detail page
  - [GOTCHA]: Route order matters - /tickets/new must come before /tickets/:id in React Router to avoid "new" being treated as an ID
  - [INTEGRATION]: Priority uses TicketPriority enum from types/ticket.ts
---
## 2026-01-24T05:27:00Z - US-013
- Implemented agent/admin ticket update controls on ticket detail page
- Added Edit Ticket button that shows Save/Cancel actions
- Added status dropdown with valid transition enforcement (matches backend STATUS_TRANSITIONS)
- Added priority dropdown with all TicketPriority enum values
- Added assignee picker that loads agents/admins via GET /api/v1/users
- Added tags input field accepting comma-separated values
- Updates sent via PATCH /api/v1/tickets/:id only include changed fields
- Displays backend validation errors (invalid transitions, missing assignee, etc)
- Ticket refreshes in real-time after successful update without page reload
- Edit controls only visible to agents/admins, hidden from customers
- Files changed:
  - web/src/pages/TicketDetail.tsx
- **Learnings for future iterations:**
  - [PATTERN]: Ticket updates use PATCH /api/v1/tickets/:id accepting status, priority, assigneeId, tags
  - [PATTERN]: Status transitions validated client-side using getValidStatusTransitions() matching backend
  - [PATTERN]: Agent/admin users loaded from GET /api/v1/users with role filter
  - [INTEGRATION]: Edit mode toggles between display and input controls for each field
  - [GOTCHA]: Must only send changed fields to avoid unnecessary updates and audit log entries
---
## 2026-01-24T05:31:00Z - US-014
- Implemented attachment uploader that posts to POST /api/v1/tickets/:id/attachments
- Added file input with 10MB size validation before upload
- Created attachments list section displaying uploaded files with download links
- Attachments shown in comments timeline with download capability
- Files changed:
  - web/src/pages/TicketDetail.tsx
- **Learnings for future iterations:**
  - [PATTERN]: File upload uses api.uploadFile() with multipart/form-data and 'file' field name
  - [PATTERN]: File size validation (10MB limit) happens client-side before API call
  - [PATTERN]: Attachments displayed as downloadable links in timeline and dedicated section
  - [INTEGRATION]: POST /api/v1/tickets/:id/attachments returns Attachment type with id, fileName, filePath, size, mimeType
  - [GOTCHA]: Must reset file input value after successful upload to allow re-selecting same file
---
## 2026-01-24T05:31:30Z - US-015
- Implemented Admin Users page listing users via GET /api/v1/users
- Added role filter dropdown to filter users by customer/agent/admin
- Created user creation form with email, displayName, password, and role fields
- Form posts to POST /api/v1/users and displays API validation errors
- Added /admin/users route accessible only to admin users
- Added "Manage Users" button to Home page for admin users
- Files changed:
  - web/src/pages/AdminUsers.tsx (new)
  - web/src/App.tsx
  - web/src/pages/Home.tsx
- **Learnings for future iterations:**
  - [PATTERN]: Admin pages check user.role === UserRole.ADMIN and show access denied for non-admins
  - [PATTERN]: List pages support pagination and filtering with page/limit and role query params
  - [PATTERN]: Create user form validates email format and password length >= 8
  - [INTEGRATION]: GET /api/v1/users returns { users, total, page, limit } with optional role filter
  - [INTEGRATION]: POST /api/v1/users accepts { email, password, displayName, role }
  - [GOTCHA]: Must reload users list after creating new user to show updated data
---
